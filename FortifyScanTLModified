Name: Fortify Scan

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment (RQA or TL)'
        required: true
        default: 'TL'

permissions:
  contents: read

concurrency:
  group: fortify-${{ github.ref }}
  cancel-in-progress: false

jobs:
  fortify:
    runs-on: arc-medium
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Fortify scan in container
      shell: bash
      run: |
        set -euo pipefail

        if [[ "${{ github.event.inputs.environment }}" == "RQA" ]]; then
          SF_USER="${{ secrets.RQA_USER }}"
          SF_PASS="${{ secrets.RQA_PASS }}"
          SF_TOKEN="${{ secrets.RQA_TOKEN }}"
        else
          SF_USER="${{ secrets.TL_USER }}"
          SF_PASS="${{ secrets.TL_PASS }}"
          SF_TOKEN="${{ secrets.TL_TOKEN }}"
        fi

        docker run --rm \
          --memory=4g \
          --network host \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v ${{ github.workspace }}:/app \
          -v /usr/bin/docker:/usr/bin/docker \
          -e DOCKER_HOST=unix:///var/run/docker.sock \
          -e HOME=/opt/fortify \
          -e SCA_VM_OPTS=-Xmx2750M \
          -e JAVA_TOOL_OPTIONS=-Duser.home=/opt/fortify \
          -e SF_USER="$SF_USER" \
          -e SF_PASS="$SF_PASS" \
          -e SF_TOKEN="$SF_TOKEN" \
          -e FORTIFY_ENV="${{ github.event.inputs.environment }}" \
          -e GITHUB_RUN_ID="${{ github.run_id }}" \
          -w /app \
          docker.artifactory.dhl.com/fortify/fortify-cloudscan-client:latest \
          bash -c "
            set -euo pipefail
            
            # Add Fortify bin to PATH immediately
            export PATH='/opt/fortify/bin:$PATH'

            # Verify Docker connectivity
            echo '::group::Verify Docker Connectivity'
            which docker
            docker version
            docker info | head -20
            echo '::endgroup::'

            # ... (rest of the script)
            echo '::group::Verify Fortify tools'
            # ... (rest of Fortify verification steps)
            echo '::endgroup::'

            # ... and so on for all your other steps ...
          "

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fortify-scan-reports
        path: |
          FortifyReport.pdf
          issues.csv
          critical.csv
          high.csv
          medium.csv
          low.csv
          target/fortify/translate.log
          target/fortify/scan.log
          target/fortify/scan.fpr
          fpl-audit.xlsx
        if-no-files-found: warn
        retention-days: 30
