name: Fortify Scan

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment (RQA or TL)'
        required: true
        default: 'TL'

jobs:
  fortify:
    runs-on: ubuntu-latest
    container:
      image: docker.artifactory.fpl.com/fortify/fortify-cloudscan-client:latest
      options: --memory=4g

    env:
      HOME: /opt/fortify
      PATH: /opt/fortify/bin:${{ env.PATH }}
      SCA_VM_OPTS: -Xmx2750M
      JAVA_TOOL_OPTIONS: -Duser.home=/opt/fortify

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Create Scripts Directory
      run: mkdir -p scripts

    - name: Set Environment Credentials
      id: set-creds
      run: |
        if [[ "${{ github.event.inputs.environment }}" == "RQA" ]]; then
          echo "user=${{ secrets.RQA_USER }}" >> $GITHUB_OUTPUT
          echo "password=${{ secrets.RQA_PASS }}" >> $GITHUB_OUTPUT
          echo "token=${{ secrets.RQA_TOKEN }}" >> $GITHUB_OUTPUT
        else
          echo "user=${{ secrets.TL_USER }}" >> $GITHUB_OUTPUT
          echo "password=${{ secrets.TL_PASS }}" >> $GITHUB_OUTPUT
          echo "token=${{ secrets.TL_TOKEN }}" >> $GITHUB_OUTPUT
        fi

    - name: Check Java and Ant
      run: |
        java -version
        chmod +x ./tools/apache-ant/apache-ant-1.10.12/bin/ant
        ./tools/apache-ant/apache-ant-1.10.12/bin/ant -version

    - name: Retrieve Code and Metadata
      run: |
        ./tools/apache-ant/apache-ant-1.10.12/bin/ant \
          -Dsf.username=${{ steps.set-creds.outputs.user }} \
          -Dsf.password=${{ steps.set-creds.outputs.password }} \
          -buildfile ./config/build.xml \
          -propertyfile ./config/build.properties retrieveCodeAndPackages

        java -Dhttp.proxyHost=b2b-http.fpl.com -Dhttp.proxyPort=8080 \
          -jar ./tools/sf-extractor/sf_extractor.jar \
          -username ${{ steps.set-creds.outputs.user }} \
          -password ${{ steps.set-creds.outputs.password }} \
          -token ${{ steps.set-creds.outputs.token }} \
          -org y

    - name: Remove Unwanted Files
      run: |
        find code -name '*Test.cls*' -delete
        find code -name 'Test_*.cls*' -delete
        find code -name 'TEST_*.cls*' -delete
        find code -name '*Exception.cls*' -delete
        find code -name '*.xml*' -delete
        find code -name '*.resource' -delete
        find code -name 'InboundEmailI*.cls*' -delete

    - name: Run Fortify Scan
      run: |
        mkdir -p target/fortify
        sourceanalyzer -version -b meinservice-${{ github.run_id }} -clean
        sourceanalyzer -version -b meinservice-${{ github.run_id }} -debug -verbose \
          -logfile target/fortify/translate.log \
          -apex code/**/* -apex-sobject-path ./sobjects.json
        sourceanalyzer -b meinservice-${{ github.run_id }} -show-files
        sourceanalyzer -b meinservice-${{ github.run_id }} -debug -verbose \
          -logfile target/fortify/scan.log -scan \
          -f target/fortify/scan.fpr \
          -build-project meinservice -build-version ${{ github.run_id }}

    - name: Generate Reports
      run: |
        BIRTReportGenerator \
          -template 'OWASP Top 10' \
          --SecurityIssueDetails --IncludeDescOfKeyTerminology --UseFortifyPriorityOrder \
          -source target/fortify/scan.fpr -format pdf \
          --Version 'OWASP Top 10 2017' -output FortifyReport.pdf

        for level in critical high medium low; do
          FPRUtility -project target/fortify/scan.fpr -information -listIssues \
            -search -query "[fortify priority order]:$level" -outputFormat CSV > $level.csv
        done

        FPRUtility -project target/fortify/scan.fpr -information -listIssues -search -queryAll -outputFormat CSV > issues.csv
        java -jar ./tools/csv-to-excel/exceliser.jar low.csv medium.csv high.csv critical.csv fpl-audit.xlsx ${{ github.event.inputs.environment }}

    - name: Upload Fortify Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fortify-scan-reports
        path: |
          FortifyReport.pdf
          issues.csv
          critical.csv
          high.csv
          medium.csv
          low.csv
          fpl-audit.xlsx
        if-no-files-found: error
        retention-days: 30
