name: Fortify Scan - Salesforce

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment (RQA or TL)'
        required: true
        default: 'TL'
        type: choice
        options: [RQA, TL]

permissions:
  contents: read

jobs:
  fortify:
    runs-on: arc-container-small
    container:
      image: docker.artifactory.fpl.com/fortify/fortify-cloudscan-client:latest
      options: --memory=4g

    env:
      HOME: /opt/fortify
      SCA_VM_OPTS: -Xmx2750M
      JAVA_TOOL_OPTIONS: -Duser.home=/opt/fortify
      BUILD_ID: salesforce-${{ github.run_id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add Fortify bin to PATH
        run: echo "/opt/fortify/bin" >> "$GITHUB_PATH"

      - name: Set Salesforce credentials
        id: creds
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "RQA" ]]; then
            echo "USER=${{ secrets.RQA_USER }}" >> $GITHUB_ENV
            echo "PASS=${{ secrets.RQA_PASS }}" >> $GITHUB_ENV
            echo "TOKEN=${{ secrets.RQA_TOKEN }}" >> $GITHUB_ENV
          else
            echo "USER=${{ secrets.TL_USER }}" >> $GITHUB_ENV
            echo "PASS=${{ secrets.TL_PASS }}" >> $GITHUB_ENV
            echo "TOKEN=${{ secrets.TL_TOKEN }}" >> $GITHUB_ENV
          fi

      - name: Retrieve Salesforce code
        run: |
          java -jar ./tools/sf-extractor/sf_extractor.jar \
            -username "$USER" \
            -password "$PASS" \
            -token "$TOKEN" \
            -org y

      - name: Run Fortify Translate
        run: |
          mkdir -p target/fortify
          sourceanalyzer -b "$BUILD_ID" -clean
          sourceanalyzer -b "$BUILD_ID" -apex "code/**/*" \
            -apex-sobject-path "./sobjects.json" \
            -logfile target/fortify/translate.log

      - name: Run Fortify Scan
        run: |
          sourceanalyzer -b "$BUILD_ID" -scan \
            -f target/fortify/scan.fpr \
            -logfile target/fortify/scan.log

      - name: Generate CSV reports
        run: |
          for level in critical high medium low; do
            FPRUtility -project target/fortify/scan.fpr \
              -information -listIssues \
              -search -query "[fortify priority order]:$level" \
              -outputFormat CSV > "${level}.csv"
          done

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: fortify-results-${{ github.event.inputs.environment }}
          path: |
            critical.csv
            high.csv
            medium.csv
            low.csv
            target/fortify/translate.log
            target/fortify/scan.log
            target/fortify/scan.fpr
          retention-days: 30
