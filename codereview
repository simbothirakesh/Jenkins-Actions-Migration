# Reusable workflow for MeinService Automation Testing
# This workflow is called by environment-specific workflows (RQA, TL)

name: MeinService - Test Automation (Reusable)
on:
  workflow_call:
    inputs:
      envChoice:
        description: 'Environment to run tests against'
        required: true
        type: string
    secrets:
      MEINSERVICE_RQA_PROPERTIES_BASE64:
        required: true
      MEINSERVICE_TL_PROPERTIES_BASE64:
        required: true
      MEINSERVICE_LOGINAS_PROPERTIES:
        required: true
      MEINSERVICE_AKBM_TL_BASE64:
        required: true
      MEINSERVICE_AKBM_RQA_BASE64:
        required: true
      MEINSERVICE_AKBM_TL_TROUBLESHOOTING_BASE64:
        required: true
      MEINSERVICE_KAUFLAND_BASE64:
        required: true
      MEINSERVICE_MASTER_PASSWORD:
        required: true
      EMAIL_SERVER_ADDRESS:
        required: true
      EMAIL_SERVER_PORT:
        required: true
      EMAIL_RECIPIENTS_QA:
        required: true

jobs:
  test:
    # Use fpl ITS Runner
    runs-on: arc-small-container
    container:
      image: docker.artifactory.fpl.com/markhobson/maven-chrome:jdk-11

    env:
      # Set environment variables for ChromeDriver and proxies
      CHROME_DRIVER: "/usr/bin/chromedriver"
      HTTPS_PROXY: "http://b2b-http.fpl.com:8080"
      HTTP_PROXY: "http://b2b-http.fpl.com:8080"
      # Credentials and connection files (from GitHub secrets)
      MEINSERVICE_CREDENTIALS_RQA: ${{ secrets.MEINSERVICE_RQA_PROPERTIES_BASE64 }}
      MEINSERVICE_CREDENTIALS_TL: ${{ secrets.MEINSERVICE_TL_PROPERTIES_BASE64 }}
      MEINSERVICE_CREDENTIALS_LOGIN_AS: ${{ secrets.MEINSERVICE_LOGINAS_PROPERTIES }}
      CONNECTION_FILE_FOR_AKBM_TL: ${{ secrets.MEINSERVICE_AKBM_TL_BASE64 }}
      CONNECTION_FILE_FOR_AKBM_RQA: ${{ secrets.MEINSERVICE_AKBM_RQA_BASE64 }}
      CONNECTION_FILE_FOR_AKBM_TL_TROUBLE_SHOOTING: ${{ secrets.MEINSERVICE_AKBM_TL_TROUBLESHOOTING_BASE64 }}
      CONNECTION_FILE_FOR_KAUFLAND: ${{ secrets.MEINSERVICE_KAUFLAND_BASE64 }}

    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Java 21 with Gradle cache
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: gradle

      # Step 3: Create required directories for resources, reports, etc.
      - name: Create directories
        run: |
          mkdir -p ./src/test/resources
          mkdir -p ./src/main/resources/akbm
          mkdir -p ./src/main/resources/kaufland
          mkdir -p ./gradletmp
          mkdir -p report
          mkdir -p screenshots
          mkdir -p logs

      # Step 4: Decode and set up environment-specific configuration files
      - name: Setup test configuration files
        run: |
          ENV_CHOICE="${{ inputs.envChoice }}"
          echo "Running tests in environment: $ENV_CHOICE"
          
          if [ "$ENV_CHOICE" = "RQA" ]; then
            export ACTUAL_ENVIRONMENT="RQA"
            echo "ACTUAL_ENVIRONMENT=RQA" >> $GITHUB_ENV
            echo "$MEINSERVICE_CREDENTIALS_RQA" | base64 -d > ./src/test/resources/test.properties
            echo "$CONNECTION_FILE_FOR_AKBM_RQA" | base64 -d > ./src/main/resources/akbm/akbm_rqa.ppk
          elif [ "$ENV_CHOICE" = "TL" ]; then
            export ACTUAL_ENVIRONMENT="TL"
            echo "ACTUAL_ENVIRONMENT=TL" >> $GITHUB_ENV
            echo "$MEINSERVICE_CREDENTIALS_TL" | base64 -d > ./src/test/resources/test.properties
            echo "$CONNECTION_FILE_FOR_AKBM_TL" | base64 -d > ./src/main/resources/akbm/akbm_tl.ppk
            echo "$CONNECTION_FILE_FOR_AKBM_TL_TROUBLE_SHOOTING" | base64 -d > ./src/main/resources/akbm/TL-MEINSERVICE-DWH.ppk
          fi
          
          echo "$CONNECTION_FILE_FOR_KAUFLAND" | base64 -d > ./src/main/resources/kaufland/MEINSERVICE_TL_OSCA.ppk
          echo "$MEINSERVICE_CREDENTIALS_LOGIN_AS" > ./src/test/resources/loginAs.properties

      # Step 5: Make Gradle wrapper executable
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Step 6: Clean Gradle cache using a custom cache directory
      - name: Clean gradle cache
        run: ./gradlew --gradle-user-home ./gradletmp clean

      # Step 7: Run Gradle tests with master password and stacktrace
      - name: Run tests
        run: |
          echo "Running Gradle tests"
          ./gradlew --gradle-user-home ./gradletmp --build-cache test -PmasterPassword=${{ secrets.MEINSERVICE_MASTER_PASSWORD }} --stacktrace

      # Step 8: Archive test artifacts (reports, screenshots, logs, test results)
      - name: Archive artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-artifacts
          path: |
            report/*
            screenshots/*
            logs/*
            build/test-results/**/*.xml
            build/reports/tests/test/*
          retention-days: 15
          if-no-files-found: ignore


      # Step 9: Send email notification on success
      - name: Send success notification
        if: success()
        uses: dawidd6/action-send-mail@v5
        with:
          server_address: ${{ secrets.EMAIL_SERVER_ADDRESS }}
          server_port: ${{ secrets.EMAIL_SERVER_PORT }}
          from: 'noreply@fpl.com'
          subject: 'MEINSERVICE QS:"${{ env.ACTUAL_ENVIRONMENT }}" Successful: -> ${{ github.repository }}'
          html_body: |
            Project: ${{ github.repository }}<br>
            Build Number: ${{ github.run_number }}<br>
            Build URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_RECIPIENTS_QA }}

      # Step 10: Send email notification on failure
      - name: Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v5
        with:
          server_address: ${{ secrets.EMAIL_SERVER_ADDRESS }}
          server_port: ${{ secrets.EMAIL_SERVER_PORT }}
          from: 'noreply@fpl.com'
          subject: 'MEINSERVICE QS:"${{ env.ACTUAL_ENVIRONMENT }}" Failed: -> ${{ github.repository }}'
          html_body: |
            Project: ${{ github.repository }}<br>
            Build Number: ${{ github.run_number }}<br>
            Build URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_RECIPIENTS_QA }}
